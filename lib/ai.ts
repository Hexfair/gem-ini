// lib/ai.ts
import { GoogleGenAI } from "@google/genai";

if (!process.env.GOOGLE_API_KEY) {
  throw new Error("GOOGLE_API_KEY is not set in environment variables");
}

const genAI = new GoogleGenAI({ apiKey: process.env.GOOGLE_API_KEY });

//const model = genAI.getGenerativeModel({ model: "gemini-2.5-pro" }); // Используем flash для скорости

/**
 * Важнейшая часть: промпт для нейросети.
 * Он должен быть составлен так, чтобы нейросеть вернула JSON
 * в том формате, который ожидает ваша функция `buildDocFromJson`.
 */
const getPrompt = (textChunk: string) => `
Ты — эксперт по структурированию новостных потоков. Задача: из большого "сырого" файла с новостями выделить отдельные события, объединить повторы/дубликаты, классифицировать их по разделам и вернуть строго валидный JSON нужного формата для генерации DOCX.

Язык ответа: русский.
Верни ТОЛЬКО JSON, без комментариев/Markdown и без пояснений до/после.

Формат JSON (строго 3 объекта в массиве, в указанном порядке):
[
  { "title": "Международная политика", "data": [ /* блоки-новости */ ] },
  { "title": "Военно-техническое сотрудничество", "data": [ /* блоки-новости */ ] },
  { "title": "Обстановка на Украине.", "data": [ /* блоки-новости */ ] }
]

Схема блока-новости (элементы массива data):
- "subtitle": string — подзаголовок (H2), геометка по правилам ниже.
- "items": Item[] — массив отдельных событий под одной геометкой (см. «Группировка в blocks и items»).

Схема Item:
- "text": string — итоговый, консолидированный текст события (многострочный, абзацы разделять символом \n).
- "images": string[] — массив http/https-URL изображений (может быть пустым []).
- "figureCaption": string — опционально; подпись к группе изображений конкретного item. Если нет изображений — поле опустить.

Группировка в blocks и items:
- Сначала распределяй новости по разделам (title) согласно классификации ниже.
- Внутри каждого раздела объединяй новости с одинаковой геометкой в один блок (один "subtitle").
- Внутри такого блока заводи по одному item на каждое отдельное событие (факт/инцидент/решение), относящееся к этой геометке.
- Повторы/дубликаты одного и того же события из разных источников консолидируй в ОДИН item.
- Порядок items: по хронологии (если распознаётся), иначе — в порядке появления в исходнике.

Сегментация исходника на новости:
- Начало каждой новости — «шапка» вида: "<id_канала> | <Название источника> | <дата/время>".
- Тело новости — всё между шапкой и следующей шапкой/разделителем.
- Блок «Изображения:» распознаётся отдельно: все строки вида "- https://..." собрать в images соответствующего item’а.

Классификация по разделам (title):
- "Международная политика": дипломатия, заявления лидеров/МИД/МО, саммиты, санкции, решения международных организаций (ООН, ЕС, НАТО), геополитика вне «поставок техники».
- "Военно-техническое сотрудничество": поставки/закупки вооружений, оборонные контракты, совместные разработки/учения, производство/логистика вооружений, ВТС.
- "Обстановка на Украине.": сводки, обстрелы/удары, боевая обстановка, решения/заявления властей Украины и иностранных лидеров В КОНТЕКСТЕ Украины.

Правила формирования subtitle (H2):
1) Для "Международная политика" и "Военно-техническое сотрудничество":
   - краткая геометка главных участника(ов):
     - одна страна: "США", "Россия", "Украина", "Израиль", "Польша", "Германия", "Франция", "Великобритания", "Китай", …
     - международная организация: "Европейский союз", "НАТО", "ООН", "БРИКС", "ШОС", …
     - две страны (если обе ведущие): "Страна1 - Страна2" (через дефис с пробелами), например: "США - Латвия", "Украина - Польша".
   - маппинг персоналий/ведомств → страна: "Дональд Трамп"/"Белый дом"/"Госдеп"/"Пентагон" → "США"; "Нетаньяху"/"ЦАХАЛ"/"ШАБАК"/"IDF" → "Израиль"; "МИД Германии"/"Бундесвер" → "Германия"; "Елисейский дворец" → "Франция"; "Дауннинг-стрит" → "Великобритания"; "Еврокомиссия"/"Европейский совет"/"ЕП" → "Европейский союз".
   - subtitle содержит ТОЛЬКО геометку, без даты/источника/заголовка.
2) Для "Обстановка на Украине.":
   - Предпочтительно выбрать из списка:
     - "Удары ВС РФ по Украине"
     - "Удары ВСУ по РФ"
     - "Обстановка в зоне СВО"
     - "Деятельность руководства Украины"
     - "Деятельность руководства иностранных государств (в контексте Украины)"
   - Если ни один не подходит — краткая точная формулировка по смыслу (по возможности оставайся в рамках списка).

КОНСОЛИДАЦИЯ И ДЕДУПЛИКАЦИЯ:
- Повторы одной и той же новости (одного события) объединяй в ОДИН item:
  - Признаки одного события: общие участники/персоны/организации, совпадающие место/время, идентичная суть, те же цифры/объекты (типы вооружений, суммы, города и т.п.).
  - При объединении:
    - Собери все существенные факты в единый связный текст: даты/время, места, имена/должности, суммы, количества, номенклатуру, при необходимости точные цитаты.
    - Если источники дополняют друг друга — включи уточнения.
    - Если есть расхождения — укажи аккуратно с атрибуцией: «по данным <источник>…», «в то же время <источник> сообщает…».
    - Не придумывай факты. Не делай выводов сверх текста.
- images: объедини все уникальные ссылки по событию (item), сохрани порядок появления; исключи дубликаты и неподходящие форматы.

ТРЕБОВАНИЯ К ТЕКСТУ (поле "text" в item):
- Пиши связно, информативно, в официальном военно-политическом стиле; избегай журналистских клише и бытовой лексики.
- Старайся начинать со сказуемого: кто, когда (не обязательно), где и что сделал.
- В первом предложении каждой новости расписывай должности/наименования полностью: например, «генеральный секретарь НАТО …», «Европейский союз …». Далее допускаются сокращения/синонимы («генсек», «Евросоюз»).
- Для упоминаний городов используй формат: «г.Москва (Россия)», «г.Лос-Анджелес (шт. Калифорния)». Город — в именительном падеже; в скобках страна, а для США — штат.
- Не ограничивай длину: включай важные детали.
- Если указаны точные время/даты/география/количественные параметры — обязательно включай их.
- Избегай повтора однокоренных слов в одном предложении и в соседних: перефразируй, меняй синтаксис.
- Сохраняй нейтральный, новостной тон. Убери хэштеги, эмодзи, рекламные вставки, «подписаться», «ссылка» и т.п.
- НЕ добавляй отдельной строкой шаблон «дата — источник — заголовок». Только цельный итоговый текст.

Правила по изображениям (поле "images" в item):
- Включай только абсолютные http/https URL (jpg/jpeg/png/gif; другие форматы по возможности исключай).
- Исключай data: URI и ссылки на svg.
- Удали повторы, сохрани исходный порядок.
- "figureCaption" указывай только если есть изображения; это краткое название группы (без «Рис. » — префикс будет добавлен при генерации DOCX).

Ограничения вывода:
- Верни ТОЛЬКО валидный JSON по указанной схеме. Никаких комментариев/Markdown/подписей.
- В каждом из 3 разделов поле "data" — массив блоков-новостей (может быть пустым []).
- В каждом блоке "items" — массив из одного или нескольких item (для отдельных событий под общей геометкой).
- Итоговый массив разделов — строго из трёх объектов и строго в указанном порядке.

Исходный материал ниже. Проанализируй, сгруппируй дубликаты, сформируй JSON строго по схеме.

ТЕКСТ ДЛЯ ОБРАБОТКИ:
<<<ВСТАВЬ_СЮДА_СОДЕРЖИМОЕ_ФАЙЛА_С_НОВОСТЯМИ>>>

— — — ПРИМЕРЫ (ориентиры; в реальном ответе верни ТОЛЬКО JSON) — — —

Пример A (Международная политика, несколько items под одной геометкой):
{
  "title": "Международная политика",
  "data": [
    {
      "subtitle": "США - Египет",
      "items": [
        {
          "text": "Президент США Дональд Трамп прибыл в г.Шарм-эш-Шейх (Египет) для участия в саммите по прекращению боевых действий в секторе Газа. Визит сопровождается консультациями с руководством Египта и делегациями стран-участниц.",
          "images": ["https://example.com/a.jpg"],
          "figureCaption": "Саммит в Шарм-эш-Шейхе"
        },
        {
          "text": "Канцелярия премьер-министра Израиля подтвердила приглашение Биньямина Нетаньяху на мероприятие. По данным израильской стороны, участие не состоялось по организационным причинам.",
          "images": []
        }
      ]
    }
  ]
}

Пример B (Военно-техническое сотрудничество, организация как геометка):
{
  "title": "Военно-техническое сотрудничество",
  "data": [
    {
      "subtitle": "НАТО",
      "items": [
        {
          "text": "Государства — члены НАТО проводят на территории Румынии учения Dacian Fall – 2025 в период с 20 октября по 13 ноября. Цель мероприятий — проверка скорости развертывания союзнических сил и отработка взаимодействия.",
          "images": ["https://example.com/n1.jpg", "https://example.com/n2.jpg"],
          "figureCaption": "Учения НАТО Dacian Fall – 2025"
        }
      ]
    }
  ]
}

Пример C (Обстановка на Украине., выбор категории под subtitle):
{
  "title": "Обстановка на Украине.",
  "data": [
    {
      "subtitle": "Обстановка в зоне СВО",
      "items": [
        {
          "text": "Профильные службы зафиксировали около 16:40 взрывы в окрестностях г.Краматорск (Украина). Компетентные органы уточняют характер инцидента и возможные последствия.",
          "images": ["https://example.com/k1.jpg"]
        }
      ]
    }
  ]
}

Вот текст для обработки:
---
${textChunk}
---
`;

export async function processChunkWithAI(chunk: string): Promise<any> {
  try {
    const prompt = getPrompt(chunk);
    const result = await genAI.models.generateContent({
      model: "gemini-2.5-pro",
      contents: prompt,
    });

    const response = result.text;
    const jsonString =
      response?.replace(/^```json\s*/, "").replace(/\s*```$/, "") || "";

    return JSON.parse(jsonString);
  } catch (error) {
    console.error("AI processing error:", error);
    // В случае ошибки возвращаем пустой массив, чтобы не сломать весь процесс
    return [];
  }
}
